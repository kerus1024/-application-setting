# sysctl settings are defined through files in
# /usr/lib/sysctl.d/, /run/sysctl.d/, and /etc/sysctl.d/.
#
# Vendors settings live in /usr/lib/sysctl.d/.
# To override a whole file, create a new file with the same in
# /etc/sysctl.d/ and put new settings there. To override
# only specific settings, add a file with a lexically later
# name in /etc/sysctl.d/ and put new settings there.
#

# For more information, see sysctl.conf(5) and sysctl.d(5).
#


# Reverse
net.ipv4.ip_forward=1
net.ipv6.conf.all.forwarding=1

kernel.msgmax = 65535
kernel.msgmnb = 65535
vm.overcommit_memory = 1
vm.swappiness = 10

#net.core.default_qdisc = fq
net.core.default_qdisc = fq_codel
#sysctl net.ipv4.tcp_available_congestion_control
net.ipv4.tcp_congestion_control = bbr
#net.ipv4.tcp_congestion_control = bbr2
net.netfilter.nf_conntrack_max = 30000
net.ipv4.tcp_mtu_probing = 1
net.ipv4.tcp_notsent_lowat = 16384
net.ipv4.tcp_slow_start_after_idle = 0
net.core.somaxconn = 32768
net.core.netdev_max_backlog = 32768
net.ipv4.tcp_tw_reuse = 1
net.ipv4.tcp_low_latency = 1
net.ipv4.tcp_moderate_rcvbuf = 1

# Decrease the time default value for tcp_fin_timeout connection
net.ipv4.tcp_fin_timeout = 15

# Decrease the time default value for connections to keep alive
net.ipv4.tcp_keepalive_time = 3600
net.ipv4.tcp_keepalive_probes = 9
net.ipv4.tcp_keepalive_intvl = 75

fs.pipe-max-size = 4194304

net.ipv4.ip_default_ttl = 241
fs.file-max = 5000000
kernel.pid_max = 262144

net.ipv4.tcp_max_orphans = 32768
net.ipv4.tcp_orphan_retries = 7
net.ipv4.tcp_no_metrics_save = 1
net.ipv4.tcp_window_scaling = 1
net.ipv4.tcp_timestamps = 1
net.ipv4.tcp_sack = 1
net.ipv4.tcp_fack = 1
net.ipv4.tcp_dsack = 1
net.ipv4.tcp_rfc1337 = 1
net.ipv4.tcp_max_tw_buckets = 1440000
net.ipv4.tcp_tw_recycle = 1
#Prevent SYN attack, enable SYNcookies (they will kick-in when the max_syn_backlog reached)
net.ipv4.tcp_syncookies = 1
net.ipv4.tcp_syn_retries = 2
net.ipv4.tcp_synack_retries = 2
net.ipv4.tcp_max_syn_backlog = 3240000

#net.ipv4.tcp_mem = 8388608 12582912 25165824
net.ipv4.tcp_mem = 22369622 33554432 67108864

#net.ipv4.udp_mem = 3145728 4194304 16777216
net.ipv4.udp_mem = 22369622 33554432 67108864
net.ipv4.udp_rmem_min = 16384
net.ipv4.udp_wmem_min = 16384

#net.core.rmem_default = 262144
#net.core.wmem_default = 262144
#net.core.rmem_max = 25165824
#net.core.wmem_max = 16777216
#net.core.optmem_max = 16777216
#net.ipv4.tcp_rmem = 4096 87380 25165824
#net.ipv4.tcp_wmem = 4096 16384 16777216

net.core.rmem_max = 67108864
net.core.wmem_max = 67108864
net.core.optmem_max = 25165824
net.core.rmem_default = 16777216
net.core.wmem_default = 16777216
net.ipv4.tcp_rmem = 262144 5592320 25165824
net.ipv4.tcp_wmem = 262144 1048576 16777216

net.ipv4.route.max_size = 8048576

net.core.busy_read=0
net.core.busy_poll=0
kernel.numa_balancing=0

# Increase size of RPC datagram queue length
#net.unix.max_dgram_qlen = 50
net.unix.max_dgram_qlen = 1024

# Don't allow the arp table to become bigger than this
net.ipv4.neigh.default.gc_thresh3 = 2048

# Tell the gc when to become aggressive with arp table cleaning.
# Adjust this based on size of the LAN. 1024 is suitable for most /24 networks
net.ipv4.neigh.default.gc_thresh2 = 1024

# Adjust where the gc will leave arp table alone - set to 32.
#net.ipv4.neigh.default.gc_thresh1 = 32
net.ipv4.neigh.default.gc_thresh1 = 256

# Adjust to arp table gc to clean-up more often
#net.ipv4.neigh.default.gc_interval = 30
net.ipv4.neigh.default.gc_interval = 60

# Increase TCP queue length
#net.ipv4.neigh.default.proxy_qlen = 96
#net.ipv4.neigh.default.unres_qlen = 6
net.ipv4.neigh.default.proxy_qlen = 96
net.ipv4.neigh.default.unres_qlen = 128

# Enable Explicit Congestion Notification (RFC 3168), disable it if it doesn't work for you
net.ipv4.tcp_ecn = 1
net.ipv4.tcp_ecn_fallback = 1
net.ipv4.tcp_reordering = 7

# How many times to retry killing an alive TCP connection
net.ipv4.tcp_retries2 = 15
net.ipv4.tcp_retries1 = 3

# Allow the TCP fastopen flag to be used, beware some firewalls do not like TFO! (kernel > 3.7)
net.ipv4.tcp_fastopen = 3

# This will enusre that immediatly subsequent connections use the new values
net.ipv4.route.flush = 1
net.ipv6.route.flush = 1
